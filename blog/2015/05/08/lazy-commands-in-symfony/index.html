
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Lazy Commands in Symfony - Because yes</title>
  <meta name="author" content="Marc Morera">

  
  <meta name="description" content="Have you ever had this scenario? 1
2
3
4
5
$ php app/console doctrine:database:drop --force
$ php app/console doctrine:database:create [Doctrine\DBAL &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mmoreram.github.io/blog/2015/05/08/lazy-commands-in-symfony/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Because yes" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=Raleway:100" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=Lora:400,400italic,700,700italic|Istok+Web:400,400italic,700,700italic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-41917921-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body>
  <div id="header-container">
    <div id="header">
      <div class="wrapper">
        <header role="banner"><hgroup>
  <h1><a href="/">Because yes</a></h1>
</hgroup>

</header>
        <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mmoreram.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
      </div>
    </div>
  </div>
  <div id="body"   >
    <div id="main">
      <div id="content">
	<div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Lazy Commands in Symfony</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-05-08T11:04:00+02:00" pubdate data-updated="true">May 8<span>th</span>, 2015</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Have you ever had this scenario?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>php app/console doctrine:database:drop --force
</span><span class='line'><span class="nv">$ </span>php app/console doctrine:database:create
</span><span class='line'>
</span><span class='line'>    <span class="o">[</span>Doctrine<span class="se">\D</span>BAL<span class="se">\E</span>xception<span class="se">\C</span>onnectionException<span class="o">]</span>
</span><span class='line'>    An exception occured in driver: SQLSTATE<span class="o">[</span>42000<span class="o">]</span> <span class="o">[</span>1049<span class="o">]</span> Unknown database <span class="s1">&#39;mydatabase&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Well, it happens and I will tell you why.</p>

<h2>Command as a Service</h2>

<p>Since Symfony version 2.4 you can define your controllers and commands as
services. This is so useful as long as you need to treat your classes as much
decoupled as possible. You can check some information about how to define them
as services in
<a href="http://symfony.com/doc/current/cookbook/console/commands_as_services.html">Symfony Documentation</a>.</p>

<p>Then, let&rsquo;s figure out that our command is intended to check an entity from your
database. Of course, your command should be as empty as possible, placing all
your business logic inside your service layer (this is not the only strategy, of
course, but there is no strategy where you lace your logic inside your command).</p>

<p>Then, using commands as services, you will have this</p>

<ul>
<li>ObjectManager as a service (or Repository)</li>
<li>Your service, intended to do whatever you need to do, for example, check that
your entities are all enabled. Your ObjectManager or Repository will be injected
here</li>
<li>Your command, intended to work as the simple layer between your cli interface
and your service layer. Your service will be injected here.</li>
</ul>


<p>Given this schema, when we require this command through the DI Container, of
course a new Service instance will be created in order to inject it through the
command constructor, and the object will have to be created as well to be
injected inside the service.</p>

<p>It means create a new connection to the database. Fair enough till now :)</p>

<h2>Commands list</h2>

<p>Let me show you some lines of code. This method is placed in a class called
<code>Application</code> inside the bundle <code>FrameworkBundle</code>. This class is intended to add
the possibility of adding Commands as services in the main Application class of
Command Component.</p>

<p><a href="https://github.com/symfony/symfony/blob/2.7/src/Symfony/Bundle/FrameworkBundle/Console/Application.php">Symfony\Bundle\FrameworkBundle\Console\Application</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="k">protected</span> <span class="k">function</span> <span class="nf">registerCommands</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nv">$container</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">kernel</span><span class="o">-&gt;</span><span class="na">getContainer</span><span class="p">();</span>
</span><span class='line'>    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">kernel</span><span class="o">-&gt;</span><span class="na">getBundles</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$bundle</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nv">$bundle</span> <span class="nx">instanceof</span> <span class="nx">Bundle</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">$bundle</span><span class="o">-&gt;</span><span class="na">registerCommands</span><span class="p">(</span><span class="nv">$this</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nv">$container</span><span class="o">-&gt;</span><span class="na">hasParameter</span><span class="p">(</span><span class="s1">&#39;console.command.ids&#39;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$container</span><span class="o">-&gt;</span><span class="na">getParameter</span><span class="p">(</span><span class="s1">&#39;console.command.ids&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nv">$id</span><span class="p">));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Oh, wait&hellip; what?</p>

<p>Register a command means instantiate it! So if we have a command with a service
injected which has an object manager injected&hellip; then we have a problem. If we
don&rsquo;t have the database created we will not be able to create it using the
Doctrine command.</p>

<p><em>~ironic~ Perfect scenario for deployment ~/ironic~</em></p>

<h2>Using Lazy services</h2>

<p>Of course we should find a solution for this scenario, in order to be able to
call this command when is needed.</p>

<p>When we define as lazy a service, this is not instanced when is injected, but
only when is accessed. You can find some information about lazy services in
<a href="http://symfony.com/doc/current/components/dependency_injection/lazy_services.html">Symfony Documentation</a>.</p>

<p>The point here is to define our service intended to work with the model as lazy.
The result will be that when we instance the Command, then a proxy object is
created and injected with all the service information.</p>

<p>Because our command will not be used as long as we don&rsquo;t need it, then the
service will not be instanced and the ObjectManager not created. We will be able
to list all the commands, and finally, call
<code>php app/console doctrine:database:create</code> properly.</p>

<h2>Implementation</h2>

<p>Some tips here&hellip;</p>

<ul>
<li>Why instancing all services when we just need them to be listed? Is it really
necessary? Doing than we are forcing some service to be defined as lazy just
because of it, and this is not and will never be a good practice.</li>
<li>If the command needs to be instanced to be listed, and assuming that this
information <del>should</del> could be cached, then, is it necessary to call the
constructor? We could get the class, build the object using <code>\ReflectionClass</code>
and request all the needed information.</li>
</ul>


<p>I invoke the community for some feedback on that. If this is really a need for
some people, we should do some push (and organize us for an implementation,
maybe) to change this implementation for next Symfony 3 version.</p>

<p>Feedback, feedback :)</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Marc Morera</span></span>

      








  


<time datetime="2015-05-08T11:04:00+02:00" pubdate data-updated="true">May 8<span>th</span>, 2015</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/commands/'>Commands</a>, <a class='category' href='/blog/categories/symfony/'>Symfony</a>, <a class='category' href='/blog/categories/lazy/'>lazy</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://mmoreram.github.io/blog/2015/05/08/lazy-commands-in-symfony/" data-via="mmoreram" data-counturl="http://mmoreram.github.io/blog/2015/05/08/lazy-commands-in-symfony/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/05/07/montando-a-pau-garcia-mila/" title="Previous Post: Montando a Pau Garcia-Milà">&laquo; Montando a Pau Garcia-Milà</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/05/08/crowdfunding-soundtrack-the-event/" title="Next Post: Crowdfunding Soundtrack - El Evento">Crowdfunding Soundtrack - El Evento &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/05/08/crowdfunding-soundtrack-the-event/">Crowdfunding Soundtrack - El Evento</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/08/lazy-commands-in-symfony/">Lazy Commands in Symfony</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/07/montando-a-pau-garcia-mila/">Montando a Pau Garcia-Milà</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/04/visithor/">Visithor, testing your routes without pain</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/25/behat-and-data-test/">Behat and data-test</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/mmoreram">@mmoreram</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'mmoreram',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


      </div>
    </div>
    <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Marc Morera -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>. Design by <a href="http://octopressthemes.com">Octopress Themes</a>.</span>
</p>

</footer>
    

<script type="text/javascript">
      var disqus_shortname = 'mmoreram';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://mmoreram.github.io/blog/2015/05/08/lazy-commands-in-symfony/';
        var disqus_url = 'http://mmoreram.github.io/blog/2015/05/08/lazy-commands-in-symfony/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





  </div>
</body>
</html>
