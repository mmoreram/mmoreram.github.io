
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Composer install in CI - Because yes</title>
  <meta name="author" content="Marc Morera">

  
  <meta name="description" content="If you have a project with a lot of dependencies, then you might now what I am
talking about. We all love composer, but we all know as well that, at &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mmoreram.com/blog/2015/09/28/composer-install-in-ci/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Because yes" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=Raleway:100" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=Lora:400,400italic,700,700italic|Istok+Web:400,400italic,700,700italic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-41917921-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body>
  <div id="header-container">
    <div id="header">
      <div class="wrapper">
        <header role="banner"><hgroup>
  <h1><a href="/">Because yes</a></h1>
</hgroup>

</header>
        <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mmoreram.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
      </div>
    </div>
  </div>
  <div id="body"   >
    <div id="main">
      <div id="content">
	<div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Composer Install in CI</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-09-28T16:53:00+02:00" pubdate data-updated="true">Sep 28<span>th</span>, 2015</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>If you have a project with a lot of dependencies, then you might now what I am
talking about. We all love composer, but we all know as well that, at least with
current PHP versions, some composer.json are very heavy to compute and fulfill.
All this problems are reduced to time, and some CI engines, like Travis, only
allow a finite number of seconds (in Travis case, 20 minutes).</p>

<p>That&rsquo;s too much!</p>

<p>I found a solution (at least, I thought), but some days ago I saw that was not a
solution at all, but a workaround that only sometimes works properly. I will
explain exactly what&rsquo;s the point here.</p>

<h3>The problem</h3>

<p>My <code>composer.json</code> is very big and composer needs too much time to compute all
the dependencies. Reducing dependencies is not an option at all, so the only way
of reducing dependencies is by doing some refactoring.</p>

<p>Any final project needs a lot of dependencies, and even if your <code>composer.json</code>
file is small, you may need a dependency with a lot of dependencies.</p>

<h3>My solution (the bad one&hellip;)</h3>

<p>This solution is only wrong if you want to test your application under several
PHP versions. That&rsquo;s my case and could be yours&hellip;</p>

<p>Well. Computing the real dependencies in my environment seems a great solution,
right? I run <code>composer update</code> in my computer, I update the <code>composer.lock</code>
version in the repository, and then I only need to do <code>composer install</code>. What
I reduce here is the computing time of all recursive dependencies from 20+
minutes to less than 5 minutes.</p>

<p>That&rsquo;s great!</p>

<h3>Why this is a bad solution?</h3>

<p>Some projects have decided to increase the minimum PHP dependency only
increasing the minor version of the package (and is not wrong, is not BC break).
If your project believes in Semantic Version (semver), is usual to find these
pieces of composer blocks</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="s2">&quot;require&quot;</span><span class="err">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;php&quot;</span><span class="p">:</span> <span class="s2">&quot;&gt;5.4&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;symfony/symfony&quot;</span><span class="p">:</span> <span class="s2">&quot;^2.7&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;doctrine/orm&quot;</span><span class="p">:</span> <span class="s2">&quot;^2.5&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;some/package&quot;</span><span class="p">:</span> <span class="s2">&quot;^1.3&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If my development environment uses PHP 5.5, then I will be able to work with
this composer requirements. Great. We update our dependencies, we update our
repository with the <code>composer.lock</code> file, and everything should work as
expected.</p>

<p>The problem here is that there is an scenario that we are not considering here,
and is that for sure, our <code>composer.lock</code> is the result of computing the
<code>composer.json</code> file in PHP 5.5, but this doesn&rsquo;t mean that same dependencies
will work as well in PHP 5.4.</p>

<p>Let&rsquo;s see the <code>some/package</code> composer definition in version 1.3.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="s2">&quot;require&quot;</span><span class="err">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;php&quot;</span><span class="p">:</span> <span class="s2">&quot;&gt;5.4&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;whatever/whatever&quot;</span><span class="p">:</span> <span class="err">*</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And then, let&rsquo;s see the same composer file in version 1.4.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="s2">&quot;require&quot;</span><span class="err">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;php&quot;</span><span class="p">:</span> <span class="s2">&quot;&gt;5.5&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;whatever/whatever&quot;</span><span class="p">:</span> <span class="err">*</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As long as we create the <code>composer.lock</code> file in our development environment
(remember, with PHP 5.5), we will use version 1.4 of package <code>some/package</code>, but
this package version is not compatible with PHP 5.4.</p>

<p>What will happens is that, when we do <code>composer install</code> in your CI, composer
will throw an Exception. And that&rsquo;s always bad news.</p>

<h3>The good solution</h3>

<p>There&rsquo;s no good solution at all. In fact, there are only partial solutions, for
example generating the <code>composer.lock</code> file with the highest PHP version
allowed, but then, if you work with a dependency that forces a PHP version in
each version, this won&rsquo;t work at all.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="s2">&quot;require&quot;</span><span class="err">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;php&quot;</span><span class="p">:</span> <span class="s2">&quot;5.4&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;whatever/whatever&quot;</span><span class="p">:</span> <span class="err">*</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, the only way of doing that is by using <code>composer update</code> in your CI
platform. The good point is that you <strong>must</strong> take care of your <code>composer.json</code>
file&hellip;</p>

<h3>For libraries</h3>

<p>If you work with a library, then use the biggest dependency scope. This will
allow more users to use your library. Of course, you will increase the final
time of composer computation time, but is not your problem at all.</p>

<p>Of course, library composer dependencies should be as small as possible.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="s2">&quot;require&quot;</span><span class="err">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;php&quot;</span><span class="p">:</span> <span class="s2">&quot;&gt;5.4&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;whatever/whatever&quot;</span><span class="p">:</span> <span class="err">*</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>For final projects</h3>

<p>Final projects have the responsibility of reducing that scope, only allowing
explicitly highest versions. Of course, final projects can host big composer
structures (at least it&rsquo;s not a bad practice&hellip;), so in that case you will have
to work harder to reduce that file.</p>

<p>The problem here is not a problem at all, so it has no sense to test your final
application under several PHP versions, at least in your CI platform. Just test
it under your current PHP version, right?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="s2">&quot;require&quot;</span><span class="err">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;php&quot;</span><span class="p">:</span> <span class="s2">&quot;5.5&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;whatever/whatever&quot;</span><span class="p">:</span> <span class="err">^</span><span class="mf">1.5</span><span class="err">.</span><span class="mi">4</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Marc Morera</span></span>

      








  


<time datetime="2015-09-28T16:53:00+02:00" pubdate data-updated="true">Sep 28<span>th</span>, 2015</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/ci/'>ci</a>, <a class='category' href='/blog/categories/composer/'>composer</a>, <a class='category' href='/blog/categories/install/'>install</a>, <a class='category' href='/blog/categories/travis/'>travis</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://mmoreram.com/blog/2015/09/28/composer-install-in-ci/" data-via="mmoreram" data-counturl="http://mmoreram.com/blog/2015/09/28/composer-install-in-ci/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/09/14/symfony-ug-be-our-friend/" title="Previous Post: Symfony UG, be our friend">&laquo; Symfony UG, be our friend</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/11/20/your-packages-dependencies/" title="Next Post: Your packages dependencies">Your packages dependencies &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/01/26/bldd-un-dd-para-dominarlos-a-todos/">BLDD, un DD para dominarlos a todos</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/03/symfony-catalunya/">Symfony Catalunya</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/09/you-probably-need-bundle-dependencies/">you probably need bundle dependencies</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/11/20/your-packages-dependencies/">Your packages dependencies</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/28/composer-install-in-ci/">Composer install in CI</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/mmoreram">@mmoreram</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'mmoreram',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


      </div>
    </div>
    <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Marc Morera -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>. Design by <a href="http://octopressthemes.com">Octopress Themes</a>.</span>
</p>

</footer>
    

<script type="text/javascript">
      var disqus_shortname = 'mmoreram';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://mmoreram.com/blog/2015/09/28/composer-install-in-ci/';
        var disqus_url = 'http://mmoreram.com/blog/2015/09/28/composer-install-in-ci/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





  </div>
</body>
</html>
